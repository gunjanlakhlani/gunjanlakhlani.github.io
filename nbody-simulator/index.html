<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gravitational N-Body Simulator | Gunjan Lakhlani</title>
    <meta name="description"
        content="Interactive gravitational N-body simulator â€” place bodies, set velocities, and watch gravity do its thing. Built with HTML5 Canvas.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #0f0f24;
            --bg-panel: #12122a;
            --bg-hover: #1a1a3a;
            --border: rgba(255, 255, 255, 0.06);
            --border-active: rgba(120, 160, 255, 0.3);
            --text-primary: #e8e8f0;
            --text-secondary: #a0a0b8;
            --text-muted: #606080;
            --accent: #7c8aff;
            --accent-glow: rgba(124, 138, 255, 0.15);
            --red: #ff6b6b;
            --teal: #4ecdc4;
            --gold: #ffe66d;
            --mint: #a8e6cf;
            --pink: #ff8b94;
            --purple: #6c5ce7;
            --orange: #fdcb6e;
            --green: #00b894;
            --radius: 8px;
            --radius-lg: 12px;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'SF Mono', monospace;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app {
            display: grid;
            grid-template-rows: auto 1fr;
            grid-template-columns: 320px 1fr;
            height: 100vh;
        }

        /* â”€â”€â”€ Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .nav {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .nav__brand {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-muted);
            text-decoration: none;
            letter-spacing: 0.03em;
            transition: color 0.2s;
        }

        .nav__brand:hover {
            color: var(--accent);
        }

        .nav__title {
            font-weight: 600;
            font-size: 1rem;
            background: linear-gradient(135deg, var(--accent), var(--teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav__links {
            display: flex;
            gap: 1.25rem;
        }

        .nav__links a {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--text-muted);
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.2s;
        }

        .nav__links a:hover {
            color: var(--text-primary);
        }

        /* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 1rem;
        }

        .panel__title {
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 0.75rem;
        }

        /* â”€â”€â”€ Preset Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .presets {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .preset-btn {
            background: var(--bg-hover);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.72rem;
            padding: 0.6rem 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .preset-btn:hover {
            border-color: var(--border-active);
            color: var(--text-primary);
            background: rgba(124, 138, 255, 0.08);
        }

        .preset-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .preset-btn .preset-icon {
            display: block;
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }

        /* â”€â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .control-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.6rem;
        }

        .control-row:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-family: var(--font-mono);
            font-size: 0.72rem;
            color: var(--text-muted);
        }

        .control-value {
            font-family: var(--font-mono);
            font-size: 0.72rem;
            color: var(--accent);
            min-width: 50px;
            text-align: right;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: var(--bg-hover);
            border-radius: 2px;
            outline: none;
            margin-top: 0.4rem;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 0 8px var(--accent-glow);
        }

        /* â”€â”€â”€ Action Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            flex: 1;
            padding: 0.65rem 0.5rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-hover);
            color: var(--text-secondary);
            font-family: var(--font-mono);
            font-size: 0.72rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .btn:hover {
            border-color: var(--accent);
            color: var(--text-primary);
        }

        .btn--primary {
            background: rgba(124, 138, 255, 0.15);
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn--primary:hover {
            background: rgba(124, 138, 255, 0.25);
        }

        .btn--danger {
            border-color: rgba(255, 107, 107, 0.3);
            color: var(--red);
        }

        .btn--danger:hover {
            background: rgba(255, 107, 107, 0.1);
            border-color: var(--red);
        }

        /* â”€â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.35rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-family: var(--font-mono);
            font-size: 0.68rem;
            color: var(--text-muted);
        }

        .stat-value {
            font-family: var(--font-mono);
            font-size: 0.72rem;
            color: var(--text-primary);
        }

        .stat-value.good {
            color: var(--teal);
        }

        .stat-value.warn {
            color: var(--gold);
        }

        .stat-value.bad {
            color: var(--red);
        }

        /* â”€â”€â”€ Instructions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .instructions {
            font-size: 0.72rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .instructions code {
            background: var(--bg-hover);
            padding: 0.1rem 0.35rem;
            border-radius: 3px;
            font-family: var(--font-mono);
            font-size: 0.68rem;
            color: var(--text-secondary);
        }

        /* â”€â”€â”€ Canvas Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .canvas-wrap {
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
        }

        #gl-canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .canvas-overlay {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-family: var(--font-mono);
            font-size: 0.7rem;
            color: var(--text-muted);
            background: rgba(10, 10, 26, 0.8);
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            pointer-events: none;
        }

        .canvas-hint {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            font-family: var(--font-mono);
            font-size: 0.72rem;
            color: var(--text-muted);
            background: rgba(10, 10, 26, 0.85);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            pointer-events: none;
            transition: opacity 0.3s;
        }

        /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }

            .sidebar {
                border-right: none;
                border-bottom: 1px solid var(--border);
                max-height: 40vh;
                overflow-y: auto;
            }
        }
    </style>
</head>

<body>

    <div class="app">
        <!-- Nav -->
        <nav class="nav">
            <a href="https://gunjanlakhlani.github.io" class="nav__brand">GL</a>
            <span class="nav__title">Gravitational N-Body Simulator</span>
            <div class="nav__links">
                <a href="https://gunjanlakhlani.github.io/blog">Blog</a>
                <a
                    href="https://gunjanlakhlani.github.io/blog/2026/02/28/building-a-gravitational-nbody-solver/">About</a>
            </div>
        </nav>

        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Presets -->
            <div class="panel">
                <div class="panel__title">Presets</div>
                <div class="presets">
                    <button class="preset-btn" data-preset="twobody">
                        <span class="preset-icon">âŠ™âŠ™</span>
                        Two-Body
                    </button>
                    <button class="preset-btn" data-preset="figure8">
                        <span class="preset-icon">âˆ</span>
                        Figure-8
                    </button>
                    <button class="preset-btn" data-preset="plummer">
                        <span class="preset-icon">âœ¦</span>
                        Cluster (50)
                    </button>
                    <button class="preset-btn" data-preset="plummer100">
                        <span class="preset-icon">âœ¦âœ¦</span>
                        Cluster (100)
                    </button>
                    <button class="preset-btn" data-preset="plummer1000">
                        <span class="preset-icon">â‚</span>
                        Cluster (1K)
                    </button>
                    <button class="preset-btn" data-preset="plummer10k">
                        <span class="preset-icon">ğŸŒŸ</span>
                        Galaxy (10K)
                    </button>
                    <button class="preset-btn" data-preset="plummer100k">
                        <span class="preset-icon">ğŸŒŒ</span>
                        Universe (100K)
                    </button>
                    <button class="preset-btn" data-preset="solar">
                        <span class="preset-icon">â˜‰</span>
                        Solar System
                    </button>
                    <button class="preset-btn" data-preset="binary_star">
                        <span class="preset-icon">âœ¶âœ¶</span>
                        Binary Star
                    </button>
                    <button class="preset-btn" data-preset="lagrange">
                        <span class="preset-icon">â–³</span>
                        Lagrange
                    </button>
                </div>
            </div>

            <!-- Controls -->
            <div class="panel">
                <div class="panel__title">Controls</div>
                <div class="control-row">
                    <span class="control-label">Timestep</span>
                    <span class="control-value" id="dt-display">0.002</span>
                </div>
                <input type="range" id="dt-slider" min="-4" max="-1" step="0.1" value="-2.7">
                <div class="control-row" style="margin-top: 0.6rem;">
                    <span class="control-label">Body Mass</span>
                    <span class="control-value" id="mass-display">1.0</span>
                </div>
                <input type="range" id="mass-slider" min="-1" max="2" step="0.1" value="0">
                <div class="control-row" style="margin-top: 0.6rem;">
                    <span class="control-label">Trail Length</span>
                    <span class="control-value" id="trail-display">150</span>
                </div>
                <input type="range" id="trail-slider" min="0" max="500" step="10" value="150">
                <div class="control-row" style="margin-top: 0.6rem;">
                    <span class="control-label">Steps/Frame</span>
                    <span class="control-value" id="substep-display">4</span>
                </div>
                <input type="range" id="substep-slider" min="1" max="20" step="1" value="4">
            </div>

            <!-- Actions -->
            <div class="panel">
                <div class="panel__title">Simulation</div>
                <div class="actions">
                    <button class="btn btn--primary" id="btn-play">â–¶ Play</button>
                    <button class="btn" id="btn-step">â­ Step</button>
                    <button class="btn" id="btn-reset-view">âŠ Reset View</button>
                    <button class="btn btn--danger" id="btn-clear">âœ• Clear</button>
                </div>
            </div>

            <!-- Diagnostics -->
            <div class="panel">
                <div class="panel__title">Diagnostics</div>
                <div class="stat-row">
                    <span class="stat-label">Bodies</span>
                    <span class="stat-value" id="stat-bodies">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Time</span>
                    <span class="stat-value" id="stat-time">0.000</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Energy (E)</span>
                    <span class="stat-value" id="stat-energy">â€”</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">|Î”E/Eâ‚€|</span>
                    <span class="stat-value" id="stat-derror">â€”</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">FPS</span>
                    <span class="stat-value" id="stat-fps">â€”</span>
                </div>
            </div>

            <!-- Instructions -->
            <div class="panel">
                <div class="panel__title">How to Use</div>
                <div class="instructions">
                    <p><code>Click</code> on canvas to place a body</p>
                    <p><code>Click + Drag</code> to set initial velocity</p>
                    <p>Use presets for classic configurations</p>
                    <p>Adjust mass slider before placing bodies</p>
                    <p><code>Scroll</code> to zoom in/out</p>
                    <p><code>Right-click + Drag</code> to pan the view</p>
                </div>
            </div>
        </aside>

        <!-- Canvas -->
        <div class="canvas-wrap">
            <canvas id="gl-canvas"></canvas>
            <canvas id="overlay-canvas"
                style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;"></canvas>
            <div class="canvas-overlay" id="canvas-overlay">t = 0.000</div>
            <div class="canvas-overlay" id="zoom-overlay" style="top: auto; bottom: 1rem; right: 1rem;">1.0Ã—</div>
            <div class="canvas-hint" id="canvas-hint">Click anywhere to place a body â€” drag to set velocity
                &nbsp;|&nbsp; Scroll to zoom</div>
        </div>
    </div>

    <script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Gravitational N-Body Simulator (WebGL + Web Worker)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const G = 1.0;

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let N = 0;
let positions = new Float64Array(0);
let colors = new Float32Array(0);
let masses = []; // To keep track of masses before sending to worker

let simTime = 0;
let E0 = null;
let running = false;
let colorIndex = 0;
let trailLength = 150;
let substeps = 4;
let dt = 0.002;
let placingMass = 1.0;

let trails = []; // Array of [{x,y}, ...]

// Mouse interaction
let mouseDown = false;
let mouseStartX = 0, mouseStartY = 0;
let mouseCurrX = 0, mouseCurrY = 0;

// Pan interaction
let isPanning = false;
let panStartX = 0, panStartY = 0;

// Zoom state
let baseScale = 1.0;
let panX = 0, panY = 0;

// FPS tracking
let frameCount = 0;
let lastFpsTime = performance.now();
let currentFps = 0;

// Energy stats
let currentEnergy = 0;

const COLORS = [
    '#ff6b6b', '#4ecdc4', '#ffe66d', '#a8e6cf',
    '#ff8b94', '#6c5ce7', '#fdcb6e', '#00b894',
    '#e17055', '#74b9ff', '#fd79a8', '#55efc4',
    '#ffeaa7', '#dfe6e9', '#b2bec3', '#636e72'
];

function hexToRgb(hex) {
    const r = parseInt(hex.slice(1, 3), 16) / 255;
    const g = parseInt(hex.slice(3, 5), 16) / 255;
    const b = parseInt(hex.slice(5, 7), 16) / 255;
    return [r, g, b];
}

// â”€â”€â”€ Canvases & WebGL Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvasContainer = document.querySelector('.canvas-wrap');
const glCanvas = document.getElementById('gl-canvas');
const overlayCanvas = document.getElementById('overlay-canvas');
const gl = glCanvas.getContext('webgl') || glCanvas.getContext('experimental-webgl');
const ctx = overlayCanvas.getContext('2d');

if (!gl) alert('WebGL not supported in your browser.');

let W, H, scale, offsetX, offsetY;

// WebGL variables
let shaderProgram, positionBuffer, colorBuffer, sizeBuffer;
let aPosition, aColor, aSize;
let uResolution, uOffset, uScale, uIsLargeN;

function initWebGL() {
    const vsSource = `
                attribute vec2 aPosition;
                attribute vec3 aColor;
                attribute float aSize;
                uniform vec2 uResolution;
                uniform vec2 uOffset;
                uniform float uScale;
                uniform float uIsLargeN;
                varying vec3 vColor;
                varying float vIsLargeN;
                void main() {
                    vec2 screenPos = vec2(aPosition.x * uScale + uOffset.x, -aPosition.y * uScale + uOffset.y);
                    vec2 clipSpace = (screenPos / uResolution) * 2.0 - 1.0;
                    clipSpace.y = -clipSpace.y;
                    gl_Position = vec4(clipSpace, 0.0, 1.0);
                    gl_PointSize = uIsLargeN > 0.5 ? 2.0 : aSize;
                    vColor = aColor;
                    vIsLargeN = uIsLargeN;
                }`;

    const fsSource = `
                precision mediump float;
                varying vec3 vColor;
                varying float vIsLargeN;
                void main() {
                    if (vIsLargeN > 0.5) {
                        gl_FragColor = vec4(vColor, 1.0);
                    } else {
                        vec2 coord = gl_PointCoord - vec2(0.5);
                        float dist = length(coord) * 2.0;
                        if (dist > 1.0) discard;
                        float alpha = 1.0 - smoothstep(0.5, 1.0, dist);
                        vec3 finalColor = mix(vColor, vec3(1.0), 1.0 - smoothstep(0.0, 0.3, dist));
                        gl_FragColor = vec4(finalColor, alpha);
                    }
                }`;

    function createShader(gl, type, source) {
        const shader = gl.createShader(type);
        gl.shaderSource(shader, source);
        gl.compileShader(shader);
        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) return null;
        return shader;
    }

    const vertexShader = createShader(gl, gl.VERTEX_SHADER, vsSource);
    const fragmentShader = createShader(gl, gl.FRAGMENT_SHADER, fsSource);

    shaderProgram = gl.createProgram();
    gl.attachShader(shaderProgram, vertexShader);
    gl.attachShader(shaderProgram, fragmentShader);
    gl.linkProgram(shaderProgram);

    positionBuffer = gl.createBuffer();
    colorBuffer = gl.createBuffer();
    sizeBuffer = gl.createBuffer();

    aPosition = gl.getAttribLocation(shaderProgram, 'aPosition');
    aColor = gl.getAttribLocation(shaderProgram, 'aColor');
    aSize = gl.getAttribLocation(shaderProgram, 'aSize');

    uResolution = gl.getUniformLocation(shaderProgram, 'uResolution');
    uOffset = gl.getUniformLocation(shaderProgram, 'uOffset');
    uScale = gl.getUniformLocation(shaderProgram, 'uScale');
    uIsLargeN = gl.getUniformLocation(shaderProgram, 'uIsLargeN');

    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);
}

initWebGL();

function resizeCanvas() {
    const dpr = window.devicePixelRatio || 1;
    W = canvasContainer.clientWidth;
    H = canvasContainer.clientHeight;

    glCanvas.width = W * dpr;
    glCanvas.height = H * dpr;
    glCanvas.style.width = W + 'px';
    glCanvas.style.height = H + 'px';
    gl.viewport(0, 0, glCanvas.width, glCanvas.height);

    overlayCanvas.width = W * dpr;
    overlayCanvas.height = H * dpr;
    overlayCanvas.style.width = W + 'px';
    overlayCanvas.style.height = H + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    const defaultScale = Math.min(W, H) / 8;
    scale = defaultScale * baseScale;
    offsetX = W / 2 + panX;
    offsetY = H / 2 + panY;
}

function resetView() {
    baseScale = 1.0;
    panX = 0; panY = 0;
    resizeCanvas();
    updateZoomDisplay();
}

function updateZoomDisplay() {
    document.getElementById('zoom-overlay').textContent = baseScale.toFixed(1) + 'Ã—';
}

function toScreen(x, y) { return [x * scale + offsetX, -y * scale + offsetY]; }
function toSim(sx, sy) { return [(sx - offsetX) / scale, -(sy - offsetY) / scale]; }

window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// â”€â”€â”€ Web Worker Setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const worker = new Worker('physics-worker.js');
let workerBusy = false;

worker.onmessage = function (e) {
    const msg = e.data;
    if (msg.type === 'positions') {
        N = msg.n;
        positions = new Float64Array(msg.data);
        currentEnergy = msg.energy;
        simTime = msg.simTime;

        if (N < 500 && trailLength > 0) {
            for (let i = 0; i < N; i++) {
                if (!trails[i]) trails[i] = [];
                trails[i].push({ x: positions[i * 2], y: positions[i * 2 + 1] });
                if (trails[i].length > trailLength) trails[i].shift();
            }
        }
        workerBusy = false;
    } else if (msg.type === 'bodyAdded') {
        N = msg.n;
        currentEnergy = msg.energy;
        workerBusy = false;
    } else if (msg.type === 'cleared') {
        workerBusy = false;
    }
};

function sendInitToWorker(bodies) {
    workerBusy = true;
    N = bodies.length;
    const xa = new Float64Array(N); const ya = new Float64Array(N);
    const vxa = new Float64Array(N); const vya = new Float64Array(N);
    const ma = new Float64Array(N);

    const cols = new Float32Array(N * 3);
    const sizes = new Float32Array(N);
    trails = []; masses = [];

    for (let i = 0; i < N; i++) {
        const b = bodies[i];
        xa[i] = b.x; ya[i] = b.y; vxa[i] = b.vx; vya[i] = b.vy; ma[i] = b.mass;
        masses.push(b.mass);

        const rgb = hexToRgb(b.color);
        cols[i * 3] = rgb[0]; cols[i * 3 + 1] = rgb[1]; cols[i * 3 + 2] = rgb[2];
        sizes[i] = Math.max(8, Math.min(32, 10 * Math.cbrt(b.mass)));
        trails.push([{ x: b.x, y: b.y }]);
    }
    colors = cols;
    gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, colors, gl.STATIC_DRAW);
    gl.bindBuffer(gl.ARRAY_BUFFER, sizeBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, sizes, gl.STATIC_DRAW);

    worker.postMessage({ type: 'init', n: N, x: xa.buffer, y: ya.buffer, vx: vxa.buffer, vy: vya.buffer, mass: ma.buffer }, [xa.buffer, ya.buffer, vxa.buffer, vya.buffer, ma.buffer]);
}

function sendAddBodyToWorker(x, y, vx, vy, m, color) {
    workerBusy = true;
    masses.push(m);
    const newCols = new Float32Array((N + 1) * 3);
    newCols.set(colors);
    const rgb = hexToRgb(color);
    newCols[N * 3] = rgb[0]; newCols[N * 3 + 1] = rgb[1]; newCols[N * 3 + 2] = rgb[2];
    colors = newCols;

    gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, colors, gl.STATIC_DRAW);

    const newSizes = new Float32Array(N + 1);
    for (let i = 0; i <= N; i++) newSizes[i] = Math.max(8, Math.min(32, 10 * Math.cbrt(masses[i])));
    gl.bindBuffer(gl.ARRAY_BUFFER, sizeBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, newSizes, gl.STATIC_DRAW);
    trails.push([{ x, y }]);

    worker.postMessage({ type: 'addBody', x: x, y: y, vx: vx, vy: vy, mass: m });
}

// â”€â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
    gl.clearColor(0.04, 0.04, 0.1, 0.0);
    gl.clear(gl.COLOR_BUFFER_BIT);

    if (N > 0 && positions.length >= N * 2) {
        gl.useProgram(shaderProgram);
        gl.uniform2f(uResolution, glCanvas.width, glCanvas.height);
        gl.uniform2f(uOffset, offsetX, offsetY);
        gl.uniform1f(uScale, scale);
        gl.uniform1f(uIsLargeN, N > 500 ? 1.0 : 0.0);

        const posF32 = new Float32Array(positions);
        gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
        gl.bufferData(gl.ARRAY_BUFFER, posF32, gl.DYNAMIC_DRAW);
        gl.enableVertexAttribArray(aPosition);
        gl.vertexAttribPointer(aPosition, 2, gl.FLOAT, false, 0, 0);

        gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
        gl.enableVertexAttribArray(aColor);
        gl.vertexAttribPointer(aColor, 3, gl.FLOAT, false, 0, 0);

        gl.bindBuffer(gl.ARRAY_BUFFER, sizeBuffer);
        gl.enableVertexAttribArray(aSize);
        gl.vertexAttribPointer(aSize, 1, gl.FLOAT, false, 0, 0);

        if (N > 500) gl.disable(gl.BLEND);
        else { gl.enable(gl.BLEND); gl.blendFunc(gl.SRC_ALPHA, gl.ONE); }

        gl.drawArrays(gl.POINTS, 0, N);
    }

    ctx.clearRect(0, 0, W, H);

    const isLargeN = N > 500;
    const isHugeN = N > 5000;

    if (!isHugeN) {
        ctx.strokeStyle = 'rgba(255,255,255,0.025)';
        ctx.lineWidth = 1;
        const gridStep = scale;
        for (let gx = offsetX % gridStep; gx < W; gx += gridStep) { ctx.beginPath(); ctx.moveTo(gx, 0); ctx.lineTo(gx, H); ctx.stroke(); }
        for (let gy = offsetY % gridStep; gy < H; gy += gridStep) { ctx.beginPath(); ctx.moveTo(0, gy); ctx.lineTo(W, gy); ctx.stroke(); }
    }

    if (N > 0 && positions.length >= N * 2) {
        let totalM = 0, comX = 0, comY = 0;
        for (let i = 0; i < N; i++) {
            const m = masses[i];
            totalM += m; comX += m * positions[i * 2]; comY += m * positions[i * 2 + 1];
        }
        comX /= totalM; comY /= totalM;
        const [scx, scy] = toScreen(comX, comY);
        ctx.strokeStyle = 'rgba(255,255,255,0.15)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(scx - 6, scy); ctx.lineTo(scx + 6, scy);
        ctx.moveTo(scx, scy - 6); ctx.lineTo(scx, scy + 6);
        ctx.stroke();
    }

    if (!isLargeN && trailLength > 0) {
        for (let b = 0; b < N; b++) {
            const tr = trails[b];
            if (!tr || tr.length < 2) continue;
            const c = colors;
            const hexColor = `rgb(${Math.floor(c[b * 3] * 255)},${Math.floor(c[b * 3 + 1] * 255)},${Math.floor(c[b * 3 + 2] * 255)})`;
            const len = tr.length;
            for (let i = 1; i < len; i++) {
                const alpha = (i / len) * 0.7;
                ctx.strokeStyle = hexColor.replace('rgb', 'rgba').replace(')', `,${alpha})`);
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                const [x1, y1] = toScreen(tr[i - 1].x, tr[i - 1].y);
                const [x2, y2] = toScreen(tr[i].x, tr[i].y);
                ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
            }
        }
    }

    if (mouseDown) {
        const [sx, sy] = [mouseStartX, mouseStartY];
        ctx.strokeStyle = 'rgba(255,255,255,0.6)';
        ctx.lineWidth = 2;
        ctx.setLineDash([4, 4]);
        ctx.beginPath(); ctx.moveTo(sx, sy); ctx.lineTo(mouseCurrX, mouseCurrY); ctx.stroke();
        ctx.setLineDash([]);

        ctx.fillStyle = COLORS[colorIndex % COLORS.length];
        ctx.globalAlpha = 0.5;
        const r = Math.max(3, 4 * Math.cbrt(placingMass));
        ctx.beginPath(); ctx.arc(sx, sy, r, 0, Math.PI * 2); ctx.fill();
        ctx.globalAlpha = 1.0;
    }
}

// â”€â”€â”€ UI Updates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStats() {
    document.getElementById('stat-bodies').textContent = N;
    document.getElementById('stat-time').textContent = simTime.toFixed(3);
    document.getElementById('canvas-overlay').textContent = `t = ${simTime.toFixed(3)}`;

    if (N >= 2 && currentEnergy !== undefined) {
        document.getElementById('stat-energy').textContent = currentEnergy.toExponential(4);
        if (E0 !== null && E0 !== 0) {
            const dE = Math.abs((currentEnergy - E0) / E0);
            const el = document.getElementById('stat-derror');
            el.textContent = dE.toExponential(2);
            el.className = 'stat-value ' + (dE < 1e-6 ? 'good' : dE < 1e-3 ? 'warn' : 'bad');
        }
    } else {
        document.getElementById('stat-energy').textContent = 'â€”';
        document.getElementById('stat-derror').textContent = 'â€”';
        document.getElementById('stat-derror').className = 'stat-value';
    }
    document.getElementById('stat-fps').textContent = Math.round(currentFps);
}

// â”€â”€â”€ Main loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loop() {
    if (running && N >= 2 && !workerBusy) {
        workerBusy = true;
        worker.postMessage({ type: 'step', dt: dt, substeps: substeps });
    }

    render();
    updateStats();

    frameCount++;
    const now = performance.now();
    if (now - lastFpsTime > 500) {
        currentFps = frameCount / ((now - lastFpsTime) / 1000);
        frameCount = 0;
        lastFpsTime = now;
    }

    requestAnimationFrame(loop);
}

// â”€â”€â”€ Mouse events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
overlayCanvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    const rect = overlayCanvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const [simX, simY] = toSim(mx, my);
    const zoomFactor = e.deltaY < 0 ? 1.15 : 1 / 1.15;
    baseScale *= zoomFactor;
    baseScale = Math.max(0.005, Math.min(50, baseScale));

    const defaultScale = Math.min(W, H) / 8;
    scale = defaultScale * baseScale;
    offsetX = mx - simX * scale;
    offsetY = my + simY * scale;
    panX = offsetX - W / 2;
    panY = offsetY - H / 2;

    updateZoomDisplay();
}, { passive: false });

overlayCanvas.addEventListener('contextmenu', (e) => e.preventDefault());

overlayCanvas.addEventListener('mousedown', (e) => {
    const rect = overlayCanvas.getBoundingClientRect();
    if (e.button === 2 || e.button === 1) {
        isPanning = true;
        panStartX = e.clientX - rect.left;
        panStartY = e.clientY - rect.top;
        overlayCanvas.style.cursor = 'grab';
        return;
    }
    mouseStartX = e.clientX - rect.left;
    mouseStartY = e.clientY - rect.top;
    mouseCurrX = mouseStartX;
    mouseCurrY = mouseStartY;
    mouseDown = true;
    document.getElementById('canvas-hint').style.opacity = '0';
});

overlayCanvas.addEventListener('mousemove', (e) => {
    if (isPanning) {
        const rect = overlayCanvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;
        panX += mx - panStartX;
        panY += my - panStartY;
        panStartX = mx;
        panStartY = my;
        offsetX = W / 2 + panX;
        offsetY = H / 2 + panY;
        return;
    }
    if (!mouseDown) return;
    const rect = overlayCanvas.getBoundingClientRect();
    mouseCurrX = e.clientX - rect.left;
    mouseCurrY = e.clientY - rect.top;
});

overlayCanvas.addEventListener('mouseup', (e) => {
    if (isPanning) {
        isPanning = false;
        overlayCanvas.style.cursor = 'crosshair';
        return;
    }
    if (!mouseDown) return;
    mouseDown = false;

    const rect = overlayCanvas.getBoundingClientRect();
    const ex = e.clientX - rect.left;
    const ey = e.clientY - rect.top;

    const [px, py] = toSim(mouseStartX, mouseStartY);
    const vScale = 2.0 / scale;
    const vx = (ex - mouseStartX) * vScale;
    const vy = -(ey - mouseStartY) * vScale;

    const c = COLORS[colorIndex++ % COLORS.length];
    sendAddBodyToWorker(px, py, vx, vy, placingMass, c);
    E0 = null;
});

overlayCanvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = overlayCanvas.getBoundingClientRect();
    mouseStartX = touch.clientX - rect.left;
    mouseStartY = touch.clientY - rect.top;
    mouseCurrX = mouseStartX;
    mouseCurrY = mouseStartY;
    mouseDown = true;
    document.getElementById('canvas-hint').style.opacity = '0';
}, { passive: false });

overlayCanvas.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (!mouseDown) return;
    const touch = e.touches[0];
    const rect = overlayCanvas.getBoundingClientRect();
    mouseCurrX = touch.clientX - rect.left;
    mouseCurrY = touch.clientY - rect.top;
}, { passive: false });

overlayCanvas.addEventListener('touchend', (e) => {
    e.preventDefault();
    if (!mouseDown) return;
    mouseDown = false;

    const [px, py] = toSim(mouseStartX, mouseStartY);
    const vScale = 2.0 / scale;
    const vx = (mouseCurrX - mouseStartX) * vScale;
    const vy = -(mouseCurrY - mouseStartY) * vScale;

    const c = COLORS[colorIndex++ % COLORS.length];
    sendAddBodyToWorker(px, py, vx, vy, placingMass, c);
    E0 = null;
}, { passive: false });

// â”€â”€â”€ Controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dtSlider = document.getElementById('dt-slider');
const massSlider = document.getElementById('mass-slider');
const trailSlider = document.getElementById('trail-slider');
const substepSlider = document.getElementById('substep-slider');

dtSlider.addEventListener('input', () => {
    dt = Math.pow(10, parseFloat(dtSlider.value));
    document.getElementById('dt-display').textContent = dt.toFixed(4);
});

massSlider.addEventListener('input', () => {
    placingMass = Math.pow(10, parseFloat(massSlider.value));
    document.getElementById('mass-display').textContent = placingMass.toFixed(1);
});

trailSlider.addEventListener('input', () => {
    trailLength = parseInt(trailSlider.value);
    document.getElementById('trail-display').textContent = trailLength;
});

substepSlider.addEventListener('input', () => {
    substeps = parseInt(substepSlider.value);
    document.getElementById('substep-display').textContent = substeps;
});

dt = Math.pow(10, parseFloat(dtSlider.value));
document.getElementById('dt-display').textContent = dt.toFixed(4);

const btnPlay = document.getElementById('btn-play');
btnPlay.addEventListener('click', () => {
    running = !running;
    btnPlay.textContent = running ? 'â¸ Pause' : 'â–¶ Play';
    btnPlay.className = running ? 'btn btn--danger' : 'btn btn--primary';
    if (running && E0 === null && N >= 2 && currentEnergy !== undefined) E0 = currentEnergy;
});

document.getElementById('btn-step').addEventListener('click', () => {
    if (N < 2 || workerBusy) return;
    if (E0 === null && currentEnergy !== undefined) E0 = currentEnergy;
    workerBusy = true;
    worker.postMessage({ type: 'step', dt: dt, substeps: substeps });
});

document.getElementById('btn-reset-view').addEventListener('click', resetView);

document.getElementById('btn-clear').addEventListener('click', () => {
    worker.postMessage({ type: 'clear' });
    workerBusy = true;
    N = 0; positions = new Float64Array(0); colors = new Float32Array(0);
    masses = []; trails = [];
    simTime = 0; E0 = null; currentEnergy = 0; colorIndex = 0;
    running = false;
    btnPlay.textContent = 'â–¶ Play';
    btnPlay.className = 'btn btn--primary';
    document.getElementById('canvas-hint').style.opacity = '1';
});

// â”€â”€â”€ Presets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const presetBtns = document.querySelectorAll('.preset-btn');
presetBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        loadPreset(btn.dataset.preset);
        presetBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('canvas-hint').style.opacity = '0';
    });
});

function loadPreset(name) {
    let tmpBodies = [];
    colorIndex = 0;

    switch (name) {
        case 'twobody': {
            const d = 1.0, m = 1.0;
            const v = Math.sqrt(G * m / (4.0 * d));
            tmpBodies.push({ x: -d / 2, y: 0, vx: 0, vy: v, mass: m, color: COLORS[0] });
            tmpBodies.push({ x: d / 2, y: 0, vx: 0, vy: -v, mass: m, color: COLORS[1] });
            break;
        }
        case 'figure8': {
            tmpBodies.push({ x: 0.97000436, y: -0.24308753, vx: 0.46620368, vy: 0.43236573, mass: 1.0, color: COLORS[0] });
            tmpBodies.push({ x: -0.97000436, y: 0.24308753, vx: 0.46620368, vy: 0.43236573, mass: 1.0, color: COLORS[1] });
            tmpBodies.push({ x: 0, y: 0, vx: -0.93240737, vy: -0.86473146, mass: 1.0, color: COLORS[2] });
            break;
        }
        case 'plummer': {
            const N = 50, a = 1.0, totalMass = 10.0, mi = totalMass / N;
            for (let i = 0; i < N; i++) {
                let u = Math.random();
                while (u < 1e-10) u = Math.random();
                const r = a / Math.sqrt(Math.pow(u, -2 / 3) - 1);
                const theta = Math.acos(2 * Math.random() - 1);
                const phi = 2 * Math.PI * Math.random();
                const px = r * Math.sin(theta) * Math.cos(phi);
                const py = r * Math.sin(theta) * Math.sin(phi);

                const ve = Math.sqrt(2 * totalMass / Math.sqrt(r * r + a * a));
                let q, fq;
                do {
                    q = Math.random();
                    fq = Math.random();
                } while (fq > q * q * Math.pow(1 - q * q, 3.5));
                const v = q * ve;
                const vphi = 2 * Math.PI * Math.random();
                const vcostheta = 2 * Math.random() - 1;
                const vsintheta = Math.sqrt(1 - vcostheta * vcostheta);
                const vxp = v * vsintheta * Math.cos(vphi);
                const vyp = v * vsintheta * Math.sin(vphi);

                tmpBodies.push({ x: px, y: py, vx: vxp, vy: vyp, mass: mi, color: COLORS[i % COLORS.length] });
            }
            centerOfMassCorrection(tmpBodies);
            break;
        }
        case 'plummer100': {
            const N = 100, a = 1.2, totalMass = 20.0, mi = totalMass / N;
            for (let i = 0; i < N; i++) {
                let u = Math.random();
                while (u < 1e-10) u = Math.random();
                const r = a / Math.sqrt(Math.pow(u, -2 / 3) - 1);
                const theta = Math.acos(2 * Math.random() - 1);
                const phi = 2 * Math.PI * Math.random();
                const px = r * Math.sin(theta) * Math.cos(phi);
                const py = r * Math.sin(theta) * Math.sin(phi);

                const ve = Math.sqrt(2 * totalMass / Math.sqrt(r * r + a * a));
                let q, fq;
                do {
                    q = Math.random();
                    fq = Math.random();
                } while (fq > q * q * Math.pow(1 - q * q, 3.5));
                const v = q * ve;
                const vphi = 2 * Math.PI * Math.random();
                const vcostheta = 2 * Math.random() - 1;
                const vsintheta = Math.sqrt(1 - vcostheta * vcostheta);
                const vxp = v * vsintheta * Math.cos(vphi);
                const vyp = v * vsintheta * Math.sin(vphi);

                tmpBodies.push({ x: px, y: py, vx: vxp, vy: vyp, mass: mi, color: COLORS[i % COLORS.length] });
            }
            centerOfMassCorrection(tmpBodies);
            break;
        }
        case 'plummer1000': {
            const N = 1000, a = 2.0, totalMass = 50.0, mi = totalMass / N;
            for (let i = 0; i < N; i++) {
                let u = Math.random();
                while (u < 1e-10) u = Math.random();
                const r = a / Math.sqrt(Math.pow(u, -2 / 3) - 1);
                const theta = Math.acos(2 * Math.random() - 1);
                const phi = 2 * Math.PI * Math.random();
                const px = r * Math.sin(theta) * Math.cos(phi);
                const py = r * Math.sin(theta) * Math.sin(phi);

                const ve = Math.sqrt(2 * totalMass / Math.sqrt(r * r + a * a));
                let q, fq;
                do {
                    q = Math.random();
                    fq = Math.random();
                } while (fq > q * q * Math.pow(1 - q * q, 3.5));
                const v = q * ve;
                const vphi = 2 * Math.PI * Math.random();
                const vcostheta = 2 * Math.random() - 1;
                const vsintheta = Math.sqrt(1 - vcostheta * vcostheta);
                const vxp = v * vsintheta * Math.cos(vphi);
                const vyp = v * vsintheta * Math.sin(vphi);

                tmpBodies.push({ x: px, y: py, vx: vxp, vy: vyp, mass: mi, color: COLORS[i % COLORS.length] });
            }
            centerOfMassCorrection(tmpBodies);

            baseScale = 0.5; panX = 0; panY = 0; resizeCanvas(); updateZoomDisplay();
            trailLength = 30; trailSlider.value = 30; document.getElementById('trail-display').textContent = '30';
            substeps = 2; substepSlider.value = 2; document.getElementById('substep-display').textContent = '2';
            break;
        }
        case 'plummer10k': {
            const N = 10000, a = 3.0, totalMass = 100.0, mi = totalMass / N;
            for (let i = 0; i < N; i++) {
                let u = Math.random();
                while (u < 1e-10) u = Math.random();
                const r = a / Math.sqrt(Math.pow(u, -2 / 3) - 1);
                const theta = Math.acos(2 * Math.random() - 1);
                const phi = 2 * Math.PI * Math.random();
                const px = r * Math.sin(theta) * Math.cos(phi);
                const py = r * Math.sin(theta) * Math.sin(phi);

                const ve = Math.sqrt(2 * totalMass / Math.sqrt(r * r + a * a));
                let q, fq;
                do {
                    q = Math.random();
                    fq = Math.random();
                } while (fq > q * q * Math.pow(1 - q * q, 3.5));
                const v = q * ve;
                const vphi = 2 * Math.PI * Math.random();
                const vcostheta = 2 * Math.random() - 1;
                const vsintheta = Math.sqrt(1 - vcostheta * vcostheta);
                const vxp = v * vsintheta * Math.cos(vphi);
                const vyp = v * vsintheta * Math.sin(vphi);

                tmpBodies.push({ x: px, y: py, vx: vxp, vy: vyp, mass: mi, color: COLORS[i % COLORS.length] });
            }
            centerOfMassCorrection(tmpBodies);

            baseScale = 0.25; panX = 0; panY = 0; resizeCanvas(); updateZoomDisplay();
            trailLength = 0; trailSlider.value = 0; document.getElementById('trail-display').textContent = '0';
            substeps = 1; substepSlider.value = 1; document.getElementById('substep-display').textContent = '1';
            break;
        }
        case 'plummer100k': {
            const N = 100000, a = 5.0, totalMass = 500.0, mi = totalMass / N;
            for (let i = 0; i < N; i++) {
                let u = Math.random();
                while (u < 1e-10) u = Math.random();
                const r = a / Math.sqrt(Math.pow(u, -2 / 3) - 1);
                const theta = Math.acos(2 * Math.random() - 1);
                const phi = 2 * Math.PI * Math.random();
                const px = r * Math.sin(theta) * Math.cos(phi);
                const py = r * Math.sin(theta) * Math.sin(phi);

                const ve = Math.sqrt(2 * totalMass / Math.sqrt(r * r + a * a));
                let q, fq;
                do {
                    q = Math.random();
                    fq = Math.random();
                } while (fq > q * q * Math.pow(1 - q * q, 3.5));
                const v = q * ve;
                const vphi = 2 * Math.PI * Math.random();
                const vcostheta = 2 * Math.random() - 1;
                const vsintheta = Math.sqrt(1 - vcostheta * vcostheta);
                const vxp = v * vsintheta * Math.cos(vphi);
                const vyp = v * vsintheta * Math.sin(vphi);

                tmpBodies.push({ x: px, y: py, vx: vxp, vy: vyp, mass: mi, color: COLORS[i % COLORS.length] });
            }
            centerOfMassCorrection(tmpBodies);

            baseScale = 0.15; panX = 0; panY = 0; resizeCanvas(); updateZoomDisplay();
            trailLength = 0; trailSlider.value = 0; document.getElementById('trail-display').textContent = '0';
            substeps = 1; substepSlider.value = 1; document.getElementById('substep-display').textContent = '1';
            break;
        }
        case 'solar': {
            const sunMass = 100;
            tmpBodies.push({ x: 0, y: 0, vx: 0, vy: 0, mass: sunMass, color: '#ffe66d' });

            const planets = [
                { r: 0.8, m: 0.1, color: '#a0a0a0' },
                { r: 1.2, m: 0.3, color: '#fdcb6e' },
                { r: 1.7, m: 0.4, color: '#4ecdc4' },
                { r: 2.3, m: 0.2, color: '#ff6b6b' },
            ];
            for (const p of planets) {
                const v = Math.sqrt(G * sunMass / p.r);
                const angle = Math.random() * 2 * Math.PI;
                tmpBodies.push({
                    x: p.r * Math.cos(angle), y: p.r * Math.sin(angle),
                    vx: -v * Math.sin(angle), vy: v * Math.cos(angle),
                    mass: p.m, color: p.color
                });
            }
            break;
        }
        case 'binary_star': {
            const m1 = 10, m2 = 10, d = 1.5;
            const vOrb = Math.sqrt(G * m2 / (4 * d));
            tmpBodies.push({ x: -d / 2, y: 0, vx: 0, vy: vOrb, mass: m1, color: '#ff6b6b' });
            tmpBodies.push({ x: d / 2, y: 0, vx: 0, vy: -vOrb, mass: m2, color: '#4ecdc4' });

            const rp = 3.5, mp = 0.1;
            const vp = Math.sqrt(G * (m1 + m2) / rp);
            tmpBodies.push({ x: rp, y: 0, vx: 0, vy: vp, mass: mp, color: '#ffe66d' });
            break;
        }
        case 'lagrange': {
            const m = 1.0;
            const R = 1.0;
            const omega = Math.sqrt(3 * G * m / (R * R * R));
            for (let k = 0; k < 3; k++) {
                const angle = (2 * Math.PI * k) / 3;
                const px = R * Math.cos(angle);
                const py = R * Math.sin(angle);
                const vx = -omega * py;
                const vy = omega * px;
                tmpBodies.push({ x: px, y: py, vx: vx, vy: vy, mass: m, color: COLORS[k] });
            }
            break;
        }
    }

    E0 = null;
    sendInitToWorker(tmpBodies);

    running = true;
    btnPlay.textContent = 'â¸ Pause';
    btnPlay.className = 'btn btn--danger';

    const checkE0 = setInterval(() => {
        if (!workerBusy && currentEnergy !== undefined) {
            E0 = currentEnergy;
            clearInterval(checkE0);
        }
    }, 50);
}

function centerOfMassCorrection(bList) {
    let cx = 0, cy = 0, cvx = 0, cvy = 0, M = 0;
    for (const b of bList) {
        M += b.mass;
        cx += b.mass * b.x; cy += b.mass * b.y;
        cvx += b.mass * b.vx; cvy += b.mass * b.vy;
    }
    cx /= M; cy /= M; cvx /= M; cvy /= M;
    for (const b of bList) {
        b.x -= cx; b.y -= cy;
        b.vx -= cvx; b.vy -= cvy;
    }
}

// â”€â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
requestAnimationFrame(loop);

    </script>
</body>

</html>